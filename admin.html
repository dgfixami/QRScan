<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - QR Code Scanner</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add CSP header -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://accounts.google.com https://unpkg.com https://script.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://*.googleusercontent.com; connect-src 'self' https://api.ipify.org https://script.google.com">
    <!-- Add security script -->
    <script src="security.js"></script>
    <script>
        // Check if user is authenticated as admin before showing content
        document.addEventListener('DOMContentLoaded', function() {
            const currentAdmin = JSON.parse(localStorage.getItem('qrscan_current_admin'));
            
            // Enhanced security check - verify both domain and email format
            if (!currentAdmin || 
                currentAdmin.hd !== 'fixami.com' || 
                !currentAdmin.email || 
                !currentAdmin.email.endsWith('@fixami.com')) {
                // Redirect to login page if not authenticated properly
                window.location.href = 'login.html';
            }
            
            // Add CSRF token to all forms
            document.querySelectorAll('form').forEach(form => {
                const csrfToken = localStorage.getItem('qrscan_csrf_token');
                if (csrfToken) {
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = 'csrf';
                    tokenInput.value = csrfToken;
                    form.appendChild(tokenInput);
                }
            });
        });
    </script>
</head>
<body>
    <div class="admin-container">
        <div class="header-bar">
            <h1>Admin Panel</h1>
            <div class="admin-user-info">
                <div class="admin-profile" id="admin-profile">
                    <!-- Will be populated with admin info -->
                </div>
                <div>
                    <button id="scanner-link" class="admin-btn edit">Go to Scanner</button>
                    <button id="admin-logout" class="logout-button">Logout</button>
                </div>
            </div>
        </div>
        
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="access-requests">Access Requests</button>
            <button class="admin-tab" data-tab="ip-whitelist">IP Whitelist</button>
        </div>
        
        <div id="access-requests" class="admin-panel-section active">
            <h2>Access Requests</h2>
            <div class="section-description">
                <p>Review access requests from users. Each request is linked to a specific IP address.</p>
            </div>
            <div id="request-list">
                <!-- Request items will be added here dynamically using DOM methods -->
                <p class="no-items-message">No pending access requests.</p>
            </div>
        </div>
        
        <div id="ip-whitelist" class="admin-panel-section">
            <h2>IP Whitelist</h2>
            <button id="add-ip-btn" class="admin-btn edit">Add New IP</button>
            <div id="ip-list">
                <!-- IP items will be added here dynamically using DOM methods -->
                <p class="no-items-message">No whitelisted IP addresses.</p>
            </div>
        </div>
        
        <!-- Add IP Modal - with CSRF protection and input validation -->
        <dialog id="add-ip-modal">
            <h3>Add New IP Address</h3>
            <form id="add-ip-form" class="auth-form">
                <!-- CSRF token will be added by JavaScript -->
                <input type="text" id="new-ip-name" placeholder="User Name" required 
                       pattern="[A-Za-z0-9 ._-]{3,50}" 
                       title="Name must be 3-50 characters and contain only letters, numbers, spaces and ._-">
                <input type="text" id="new-ip-address" placeholder="IP Address (e.g. 192.168.1.1)" required 
                       pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                       title="Please enter a valid IPv4 address">
                <div>
                    <button type="submit" class="admin-btn approve">Add IP</button>
                    <button type="button" id="cancel-add-ip" class="admin-btn reject">Cancel</button>
                </div>
            </form>
        </dialog>
    </div>
    
    <script>
        // Display admin info using DOM methods instead of innerHTML
        document.addEventListener('DOMContentLoaded', function() {
            const currentAdmin = JSON.parse(localStorage.getItem('qrscan_current_admin'));
            if (currentAdmin) {
                const profileDiv = document.getElementById('admin-profile');
                if (profileDiv) {
                    // Clear any existing content
                    profileDiv.innerHTML = '';
                    
                    // Create and append avatar image
                    const avatarImg = document.createElement('img');
                    avatarImg.src = currentAdmin.picture;
                    avatarImg.alt = currentAdmin.name;
                    avatarImg.className = 'admin-avatar';
                    
                    // Create and append name span
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'admin-name';
                    nameSpan.textContent = currentAdmin.name;
                    
                    // Append to profile div
                    profileDiv.appendChild(avatarImg);
                    profileDiv.appendChild(nameSpan);
                }
            }
        });
    </script>
    
    <script src="security.js"></script>
    <script src="auth.js"></script>
</body>
</html>
