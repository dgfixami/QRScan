<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - QR Code Scanner</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self'; img-src 'self' https://*.googleusercontent.com data:; connect-src 'self' https://api.ipify.org;">
    <script>
        // Check if user is authenticated as admin before showing content
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Admin.html authentication check started");
            const currentAdmin = JSON.parse(localStorage.getItem('qrscan_current_admin'));
            
            // If admin data exists, verify domain using hd property
            if (!currentAdmin || currentAdmin.hd !== 'fixami.com') {
                console.log("Not authenticated as admin, redirecting to login");
                // Redirect to login page if not from fixami.com domain
                window.location.href = 'login.html';
            } else {
                console.log("Admin verified:", currentAdmin.email);
                // Mark as admin and verified in session
                sessionStorage.setItem('admin_access', 'true');
                sessionStorage.setItem('access_verified', 'true');
            }
        });
    </script>
</head>
<body>
    <div class="admin-container">
        <div class="header-bar">
            <h1>Admin Panel</h1>
            <div class="admin-user-info">
                <div class="admin-profile" id="admin-profile">
                    <!-- Will be populated with admin info -->
                </div>
                <div>
                    <button id="scanner-link" class="admin-btn edit">Go to Scanner</button>
                    <button id="admin-logout" class="logout-button">Logout</button>
                </div>
            </div>
        </div>
        
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="access-requests">Access Requests</button>
            <button class="admin-tab" data-tab="ip-whitelist">IP Whitelist</button>
        </div>
        
        <div id="access-requests" class="admin-panel-section active">
            <h2>Access Requests</h2>
            <div class="section-description">
                <p>Review access requests from users. Each request is linked to a specific IP address.</p>
            </div>
            <div id="request-list">
                <!-- Request items will be added here dynamically -->
                <p class="no-items-message">No pending access requests.</p>
            </div>
        </div>
        
        <div id="ip-whitelist" class="admin-panel-section">
            <h2>IP Whitelist</h2>
            <button id="add-ip-btn" class="admin-btn edit">Add New IP</button>
            <div id="ip-list">
                <!-- IP items will be added here dynamically -->
                <p class="no-items-message">No whitelisted IP addresses.</p>
            </div>
        </div>
        
        <!-- Add IP Modal with improved validation -->
        <dialog id="add-ip-modal">
            <h3>Add New IP Address</h3>
            <form id="add-ip-form" class="auth-form">
                <!-- Add CSRF token -->
                <input type="hidden" id="add_ip_csrf_token" name="csrf_token">
                
                <input type="text" id="new-ip-name" placeholder="User Name" required 
                       minlength="2" maxlength="50" 
                       pattern="[A-Za-z\s\-']+" 
                       title="Please enter a valid name with letters, spaces, hyphens or apostrophes">
               
                <input type="text" id="new-ip-address" placeholder="IP Address (e.g. 192.168.1.1)" required 
                       pattern="^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                       title="Please enter a valid IPv4 address (e.g. 192.168.1.1)">
                <div>
                    <button type="submit" class="admin-btn approve">Add IP</button>
                    <button type="button" id="cancel-add-ip" class="admin-btn reject">Cancel</button>
                </div>
            </form>
        </dialog>
    </div>
    
    <script>
        // Display admin info
        document.addEventListener('DOMContentLoaded', function() {
            const currentAdmin = JSON.parse(localStorage.getItem('qrscan_current_admin'));
            if (currentAdmin) {
                const profileDiv = document.getElementById('admin-profile');
                if (profileDiv) {
                    // Use safe DOM methods instead of innerHTML
                    profileDiv.textContent = '';
                    
                    const img = document.createElement('img');
                    img.src = currentAdmin.picture;
                    img.alt = currentAdmin.name;
                    img.className = 'admin-avatar';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'admin-name';
                    nameSpan.textContent = currentAdmin.name;
                    
                    profileDiv.appendChild(img);
                    profileDiv.appendChild(nameSpan);
                }
            }
            
            // Set CSRF token for Add IP form
            const csrfToken = sessionStorage.getItem('csrf_token');
            if (csrfToken) {
                document.getElementById('add_ip_csrf_token').value = csrfToken;
            } else {
                // Generate a new token if none exists
                const array = new Uint8Array(16);
                window.crypto.getRandomValues(array);
                const newToken = Array.from(array, byte => ('0' + (byte & 0xFF).toString(16)).slice(-2)).join('');
                sessionStorage.setItem('csrf_token', newToken);
                document.getElementById('add_ip_csrf_token').value = newToken;
            }
        });
    </script>
    
    <script src="auth.js"></script>
</body>
</html>
