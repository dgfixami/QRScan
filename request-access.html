<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Access - QR Code Scanner</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self'; img-src 'self' data:; connect-src 'self' https://api.ipify.org;">
</head>
<body>
    <div class="auth-container">
        <h1>QR Code Scanner</h1>
        <h2>Request Access</h2>
        
        <div id="request-message" class="auth-message" style="display: none;"></div>
        
        <div class="ip-info">
            <p>Your device will be identified using IP: <span id="user-ip" class="ip-address">Loading...</span></p>
        </div>
        
        <!-- New element to display pending request status -->
        <div id="request-status" class="request-status" style="display: none;"></div>
        
        <!-- Simplified form with inline submit handler -->
        <form class="auth-form" id="request-form" onsubmit="return submitRequest(event)">
            <input type="text" id="request-name" placeholder="Your Name" 
                   required minlength="2" maxlength="50" 
                   pattern="[A-Za-z\s\-']+" 
                   title="Please enter a valid name with letters, spaces, hyphens or apostrophes">
            
            <button type="submit" id="submit-btn">Submit Request</button>
        </form>
        
        <div class="auth-links">
            <p>Admin? <a href="login.html">Login</a></p>
        </div>
    </div>
    
    <script>
        // Variables to store IP information
        let userIP = "";
        
        // Wait for page to load before initializing
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded, initializing request form");
            
            // Clear any previous access verification flags
            sessionStorage.removeItem('access_verified');
            sessionStorage.removeItem('access_timestamp');
            
            // Get the current URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Show revoked message if applicable
            if (urlParams.get('revoked') === 'true') {
                showMessage("Your access has been revoked. Please submit a new request if needed.", 'warning');
            }
            
            // Get user IP and initialize the form
            fetchUserIP();
        });
        
        // Function to get IP address and initialize
        async function fetchUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                userIP = data.ip;
                
                // Display user IP
                document.getElementById('user-ip').textContent = userIP;
                
                // Check if IP is already whitelisted
                if (isWhitelisted(userIP)) {
                    console.log("IP is already whitelisted");
                    handleWhitelistedIP();
                    return;
                }
                
                // Check if request is already pending
                if (hasPendingRequest(userIP)) {
                    console.log("IP has pending request");
                    handlePendingRequest();
                    return;
                }
                
                console.log("Form ready for submission");
                
            } catch (error) {
                console.error("Error fetching IP address:", error);
                document.getElementById('user-ip').textContent = "Error";
                showMessage("Error identifying your device. Please try again later.", 'error');
            }
        }
        
        // Main form submission function
        function submitRequest(event) {
            event.preventDefault();
            console.log("Submit button clicked");
            
            const nameInput = document.getElementById('request-name');
            const name = nameInput.value.trim();
            const submitBtn = document.getElementById('submit-btn');
            
            // Disable button to prevent multiple submissions
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            console.log("Processing request for:", name, userIP);
            
            // Validate name input
            if (!name) {
                showMessage("Please enter your name", 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Request';
                return false;
            }
            
            try {
                // Check again if already whitelisted
                if (isWhitelisted(userIP)) {
                    handleWhitelistedIP();
                    return false;
                }
                
                // Check again if request exists
                if (hasPendingRequest(userIP)) {
                    handlePendingRequest();
                    return false;
                }
                
                // Submit the access request
                const success = addAccessRequest(name, userIP);
                
                if (success) {
                    // Show success message
                    showMessage("Your access request has been submitted. Please wait for admin approval.", 'success');
                    
                    // Update UI to show pending state
                    showPendingRequestStatus(name);
                    
                    // Disable the form
                    disableForm();
                } else {
                    showMessage("Error submitting your request. Please try again.", 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Request';
                }
            } catch (error) {
                console.error("Error in form submission:", error);
                showMessage("An unexpected error occurred. Please try again.", 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Request';
            }
            
            return false;
        }
        
        // Check if IP is whitelisted
        function isWhitelisted(ip) {
            try {
                const whitelist = JSON.parse(localStorage.getItem('qrscan_ip_whitelist')) || [];
                return whitelist.some(entry => entry.ip === ip && entry.approved);
            } catch (error) {
                console.error("Error checking whitelist:", error);
                return false;
            }
        }
        
        // Handle already whitelisted IP
        function handleWhitelistedIP() {
            const whitelist = JSON.parse(localStorage.getItem('qrscan_ip_whitelist')) || [];
            const entry = whitelist.find(e => e.ip === userIP);
            
            if (entry) {
                // Set session storage for scanner access
                sessionStorage.setItem('access_verified', 'true');
                sessionStorage.setItem('access_timestamp', new Date().getTime());
                sessionStorage.setItem('user_name', entry.name || '');
                
                // Show approved message and redirect
                showMessage("Your device is already approved. Redirecting to scanner...", 'success');
                
                // Disable form while redirecting
                disableForm();
                
                // Redirect to scanner after delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }
        }
        
        // Check for pending request
        function hasPendingRequest(ip) {
            try {
                const requests = JSON.parse(localStorage.getItem('qrscan_access_requests')) || [];
                return requests.some(req => req.ip === ip);
            } catch (error) {
                console.error("Error checking pending requests:", error);
                return false;
            }
        }
        
        // Handle existing pending request
        function handlePendingRequest() {
            const requests = JSON.parse(localStorage.getItem('qrscan_access_requests')) || [];
            const request = requests.find(req => req.ip === userIP);
            
            if (request) {
                // Show pending message
                showMessage(`You already have a pending access request as ${sanitizeText(request.name)}`, 'warning');
                
                // Show pending status
                showPendingRequestStatus(request.name);
                
                // Disable form
                disableForm();
                
                // Prefill name field
                document.getElementById('request-name').value = request.name;
            }
        }
        
        // Add new access request
        function addAccessRequest(name, ip) {
            try {
                const requests = JSON.parse(localStorage.getItem('qrscan_access_requests')) || [];
                
                // Add new request
                requests.push({
                    name: sanitizeText(name),
                    ip: ip,
                    requestDate: new Date().toISOString()
                });
                
                // Save to localStorage
                localStorage.setItem('qrscan_access_requests', JSON.stringify(requests));
                return true;
            } catch (error) {
                console.error("Error adding request:", error);
                return false;
            }
        }
        
        // Show pending request status
        function showPendingRequestStatus(name) {
            const statusElement = document.getElementById('request-status');
            if (statusElement) {
                const requestDate = new Date();
                const formattedDate = requestDate.toLocaleDateString() + ' ' + requestDate.toLocaleTimeString();
                
                // Create pending request display
                statusElement.innerHTML = '';
                
                const pendingDiv = document.createElement('div');
                pendingDiv.className = 'pending-request';
                
                const datePara = document.createElement('p');
                datePara.textContent = `Your request was submitted on ${formattedDate}`;
                
                const waitPara = document.createElement('p');
                waitPara.textContent = 'Please wait for an administrator to review your request.';
                
                pendingDiv.appendChild(datePara);
                pendingDiv.appendChild(waitPara);
                statusElement.appendChild(pendingDiv);
                
                statusElement.style.display = 'block';
            }
        }
        
        // Disable form after submission
        function disableForm() {
            const form = document.getElementById('request-form');
            if (form) {
                const nameInput = document.getElementById('request-name');
                const submitBtn = document.getElementById('submit-btn');
                
                nameInput.disabled = true;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Request Pending';
                submitBtn.className += ' disabled-button';
            }
        }
        
        // Show message in UI
        function showMessage(message, type) {
            const messageElement = document.getElementById('request-message');
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = `auth-message ${type}`;
                messageElement.style.display = 'block';
                
                // Auto-hide success/info messages after a delay
                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        messageElement.style.display = 'none';
                    }, 5000);
                }
            }
        }
        
        // Simple text sanitizer
        function sanitizeText(input) {
            if (typeof input !== 'string') return '';
            return input.replace(/[<>&"']/g, function(c) {
                return {
                    '<': '&lt;',
                    '>': '&gt;',
                    '&': '&amp;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[c];
            });
        }
    </script>
</body>
</html>
